Mario.LevelGenerator=function(t,i){this.Width=t,this.Height=i,this.Odds=[],this.TotalOdds=0,this.Difficulty=0,this.Type=0},Mario.LevelGenerator.prototype={CreateLevel:function(t,i){var o,e=0,r=0,a=0,h=0,d=0,n=0,s=null;for(this.Type=t,this.Difficulty=i,this.Odds[Mario.Odds.Straight]=20,this.Odds[Mario.Odds.HillStraight]=10,this.Odds[Mario.Odds.Tubes]=2+i,this.Odds[Mario.Odds.Jump]=2*i,this.Odds[Mario.Odds.Cannon]=5*i-10,this.Type!==Mario.LevelType.Overground&&(this.Odds[Mario.Odds.HillStraight]=0),e=0;e<this.Odds.length;e++)this.Odds[e]<0&&(this.Odds[e]=0),this.TotalOdds+=this.Odds[e],this.Odds[e]=this.TotalOdds-this.Odds[e];for(s=new Mario.Level(this.Width,this.Height),r+=this.BuildStraight(s,0,s.Width,!0);r<s.Width-64;)r+=this.BuildZone(s,r,s.Width-r);for(o=this.Height-1-4*Math.random()|0,s.ExitX=r+8,s.ExitY=o,a=r;a<s.Width;a++)for(h=0;h<this.Height;h++)o<=h&&s.SetBlock(a,h,145);if(t===Mario.LevelType.Castle||t===Mario.LevelType.Underground)for(a=0;a<s.Width;a++)for(n--<=0&&4<a&&(d=4*Math.random()|0,n=4+(4*Math.random()|0)),h=0;h<s.Height;h++)(4<a&&h<=d||a<1)&&s.SetBlock(a,h,145);return this.FixWalls(s),s},BuildZone:function(t,i,o){for(var e=Math.random()*this.TotalOdds|0,r=0,a=0,a=0;a<this.Odds.length;a++)this.Odds[a]<=e&&(r=a);switch(r){case Mario.Odds.Straight:return this.BuildStraight(t,i,o,!1);case Mario.Odds.HillStraight:return this.BuildHillStraight(t,i,o);case Mario.Odds.Tubes:return this.BuildTubes(t,i,o);case Mario.Odds.Jump:return this.BuildJump(t,i,o);case Mario.Odds.Cannons:return this.BuildCannons(t,i,o)}return 0},BuildJump:function(t,i,o){for(var e=2+(4*Math.random()|0),r=2*e+(2+(2*Math.random()|0)),a=0,h=0,d=0==(3*Math.random()|0),n=this.Height-1-(4*Math.random()|0),a=i;a<i+r;a++)if(a<i+e||i+r-e-1<a)for(h=0;h<this.Height;h++)n<=h?t.SetBlock(a,h,145):d&&(a<i+e?n-(a-i)+1<=h&&t.SetBlock(a,h,9):n-(i+r-a)+2<=h&&t.SetBlock(a,h,9));return r},BuildCannons:function(t,i,o){alert("cannons");var e,r=2+(10*Math.random()|0),a=this.Height-1-4*Math.random()|0,h=i+1+4*Math.random()|0,d=0,n=0;for(o<r&&(r=o),d=i;d<i+r;d++)for(h<d&&(h+=4*Math.random()*2|0),h===i+r-1&&(h+=10),e=a-(4*Math.random()|0)-1,n=0;n<this.Height;n++)a<=n?t.SetBlock(d,n,145):d===h&&e<=n&&(n===e?t.SetBlock(d,n,14):n===1+e?t.SetBlock(d,n,30):t.SetBlock(d,n,46));return r},BuildHillStraight:function(t,i,o){var e,r,a=10+(10*Math.random()|0),h=this.Height-1-4*Math.random()|0,d=0,n=0,s=h,l=!0,c=[],f=0,M=0;for(o<a&&(a=o),d=i;d<i+a;d++)for(n=0;n<this.Height;n++)h<=n&&t.SetBlock(d,n,145);for(this.AddEnemyLine(t,i+1,i+a-1,h-1);l;)if((s=s-2-3*Math.random()|0)<=0)l=!1;else if(e=3+(5*Math.random()|0),c[(r=(Math.random()*(a-e-2)|0)+i+1)-i]||c[r-i+e]||c[r-i-1]||c[r-i+e+1])l=!1;else for(c[r-i]=!0,c[r-i+e]=!0,this.AddEnemyLine(t,r,r+e,s-1),0==(4*Math.random()|0)&&(this.Decorate(t,r-1,r+e+1,s),l=!1),d=r;d<r+e;d++)for(n=s;n<h;n++)f=5,M=9,d===r&&(f=4),d===r+e-1&&(f=6),n===s&&(M=8),0===t.GetBlock(d,n)?t.SetBlock(d,n,f+16*M):(132===t.GetBlock(d,n)&&t.SetBlock(d,n,180),134===t.GetBlock(d,n)&&t.SetBlock(d,n,182));return a},AddEnemyLine:function(t,i,o,e){for(var r=0,a=0,r=i;r<o;r++)(35*Math.random()|0)<this.Difficulty+1&&(a=4*Math.random()|0,this.Difficulty<1?a=Mario.Enemy.Goomba:this.Difficulty<3&&(a=3*Math.random()|0),t.SetSpriteTemplate(r,e,new Mario.SpriteTemplate(a,(35*Math.random()|0)<this.Difficulty)))},BuildTubes:function(t,i,o){var e,r=5+(10*Math.random()|0),a=this.Height-1-4*Math.random()|0,h=i+1+4*Math.random()|0,d=a-(2*Math.random()|0)-2,n=0,s=0;for(o<r&&(r=o),n=i;n<i+r;n++)for(h+1<n&&(h+=3+(4*Math.random()|0),d=a-(2*Math.random()|0)-2),i+r-2<=h&&(h+=10),n===h&&(11*Math.random()|0)<this.Difficulty+1&&t.SetSpriteTemplate(n,d,new Mario.SpriteTemplate(Mario.Enemy.Flower,!1)),s=0;s<this.Height;s++)a<=s?t.SetBlock(n,s,145):(n===h||n===h+1)&&d<=s&&(e=10+n-h,s===d?t.SetBlock(n,s,e):t.SetBlock(n,s,16+e));return r},BuildStraight:function(t,i,o,e){var r=2+(10*Math.random()|0),a=this.Height-1-(4*Math.random()|0),h=0,d=0;for(e&&(r=10+(5*Math.random()|0)),o<r&&(r=o),h=i;h<i+r;h++)for(d=0;d<this.Height;d++)a<=d&&t.SetBlock(h,d,145);return e||5<r&&this.Decorate(t,i,i+r,a),r},Decorate:function(t,i,o,e){if(!(e<1)){var r=4*Math.random()|0,a=4*Math.random()|0,h=0;if(this.AddEnemyLine(t,i+1,o-1,e-1),0<e-2&&1<o-1-a-(i+1+r))for(h=i+1+r;h<o-1-a;h++)t.SetBlock(h,e-2,34);if(r=4*Math.random()|0,a=4*Math.random()|0,0<e-4&&2<o-1-a-(i+1+r))for(h=i+1+r;h<o-1-a;h++)h!==i+1&&h!==o-2&&0==(3*Math.random()|0)?0==(4*Math.random()|0)?t.SetBlock(h,e-4,22):t.SetBlock(h,e-4,21):0==(4*Math.random()|0)?0==(4*Math.random()|0)?t.SetBlock(h,e-4,18):t.SetBlock(h,e-4,17):t.SetBlock(h,e-4,16)}},FixWalls:function(t){for(var i=[],o=0,e=0,r=0,a=0,h=0,o=0;o<this.Width+1;o++)for(i[o]=[],e=0;e<this.Height+1;e++){for(h=0,r=o-1;r<o+1;r++)for(a=e-1;a<e+1;a++)145===t.GetBlockCapped(r,a)&&h++;i[o][e]=4===h}this.Blockify(t,i,this.Width+1,this.Height+1)},Blockify:function(t,i,o,e){for(var r=0,a=[],h=0,d=0,n=0,s=0,l=0,c=0,f=0,l=0;l<2;l++)a[l]=[];for(this.Type===Mario.LevelType.Castle?r=8:this.Type===Mario.LevelType.Underground&&(r=12),h=0;h<o;h++)for(d=0;d<e;d++){for(n=h;n<=h+1;n++)for(s=d;s<=d+1;s++)(c=n)<0&&(c=0),(f=s)<0&&(f=0),o-1<c&&(c=o-1),e-1<f&&(f=e-1),a[n-h][s-d]=i[c][f];a[0][0]===a[1][0]&&a[0][1]===a[1][1]?a[0][0]===a[0][1]?a[0][0]&&t.SetBlock(h,d,145+r):a[0][0]?t.SetBlock(h,d,161+r):t.SetBlock(h,d,129+r):a[0][0]===a[0][1]&&a[1][0]===a[1][1]?a[0][0]?t.SetBlock(h,d,146+r):t.SetBlock(h,d,144+r):a[0][0]===a[1][1]&&a[0][1]===a[1][0]?t.SetBlock(h,d,145+r):a[0][0]===a[1][0]?a[0][0]?a[0][1]?t.SetBlock(h,d,163+r):t.SetBlock(h,d,179+r):a[0][1]?t.SetBlock(h,d,130+r):t.SetBlock(h,d,128+r):a[0][1]===a[1][1]?a[0][1]?a[0][0]?t.SetBlock(h,d,147+r):t.SetBlock(h,d,131+r):a[0][0]?t.SetBlock(h,d,162+r):t.SetBlock(h,d,160+r):t.SetBlock(h,d,1+16*r)}}};