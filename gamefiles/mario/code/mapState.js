Mario.MapTile={Grass:0,Water:1,Level:2,Road:3,Decoration:4},Mario.MapState=function(){this.camera=new Enjine.Camera,this.Level=[],this.Data=[],this.XMario=0,this.YMario=0,this.XMarioA=0,this.YMarioA=0,this.MoveTime=0,this.LevelId=0,this.Farthest=0,this.XFarthestCap=0,this.YFarthestCap=0,this.MapImage=document.createElement("canvas"),this.MapImage.width=320,this.MapImage.height=240,this.MapContext=this.MapImage.getContext("2d"),this.CanEnterLevel=!1,this.EnterLevel=!1,this.LevelDifficulty=0,this.LevelType=0,this.WorldNumber=-1,this.NextWorld()},Mario.MapState.prototype=new Enjine.GameState,Mario.MapState.prototype.Enter=function(){this.WaterSprite=new Enjine.AnimatedSprite,this.WaterSprite.Image=Enjine.Resources.Images.worldMap,this.WaterSprite.SetColumnCount(16),this.WaterSprite.SetRowCount(16),this.WaterSprite.AddNewSequence("loop",14,0,14,3),this.WaterSprite.FramesPerSecond=1/3,this.WaterSprite.PlaySequence("loop",!0),this.WaterSprite.X=0,this.WaterSprite.Y=0,this.DecoSprite=new Enjine.AnimatedSprite,this.DecoSprite.Image=Enjine.Resources.Images.worldMap,this.DecoSprite.SetColumnCount(16),this.DecoSprite.SetRowCount(16),this.DecoSprite.AddNewSequence("world0",10,0,10,3),this.DecoSprite.AddNewSequence("world1",11,0,11,3),this.DecoSprite.AddNewSequence("world2",12,0,12,3),this.DecoSprite.AddNewSequence("world3",13,0,13,3),this.DecoSprite.FramesPerSecond=1/3,this.DecoSprite.PlaySequence("world0",!0),this.DecoSprite.X=0,this.DecoSprite.Y=0,this.HelpSprite=new Enjine.AnimatedSprite,this.HelpSprite.Image=Enjine.Resources.Images.worldMap,this.HelpSprite.SetColumnCount(16),this.HelpSprite.SetRowCount(16),this.HelpSprite.AddNewSequence("help",7,3,7,5),this.HelpSprite.FramesPerSecond=.5,this.HelpSprite.PlaySequence("help",!0),this.HelpSprite.X=0,this.HelpSprite.Y=0,this.SmallMario=new Enjine.AnimatedSprite,this.SmallMario.Image=Enjine.Resources.Images.worldMap,this.SmallMario.SetColumnCount(16),this.SmallMario.SetRowCount(16),this.SmallMario.AddNewSequence("small",1,0,1,1),this.SmallMario.FramesPerSecond=1/3,this.SmallMario.PlaySequence("small",!0),this.SmallMario.X=0,this.SmallMario.Y=0,this.LargeMario=new Enjine.AnimatedSprite,this.LargeMario.Image=Enjine.Resources.Images.worldMap,this.LargeMario.SetColumnCount(16),this.LargeMario.SetRowCount(8),this.LargeMario.AddNewSequence("large",0,2,0,3),this.LargeMario.AddNewSequence("fire",0,4,0,5),this.LargeMario.FramesPerSecond=1/3,this.LargeMario.PlaySequence("large",!0),this.LargeMario.X=0,this.LargeMario.Y=0,this.FontShadow=Mario.SpriteCuts.CreateBlackFont(),this.Font=Mario.SpriteCuts.CreateWhiteFont(),this.DecoSprite.PlaySequence("world"+this.WorldNumber%4,!0),Mario.MarioCharacter.Fire?this.LargeMario.PlaySequence("fire",!0):this.LargeMario.PlaySequence("large",!0),this.EnterLevel=!1,this.LevelDifficulty=0,this.LevelType=0,Mario.PlayMapMusic()},Mario.MapState.prototype.Exit=function(){Mario.StopMusic(),delete this.WaterSprite,delete this.DecoSprite,delete this.HelpSprite,delete this.SmallMario,delete this.LargeMario,delete this.FontShadow,delete this.Font},Mario.MapState.prototype.NextWorld=function(){var e=!1;if(this.WorldNumber++,8!==this.WorldNumber){for(this.MoveTime=0,this.LevelId=0,this.Farthest=0,this.XFarthestCap=0,this.YFarthestCap=0;!e;)e=this.GenerateLevel();this.RenderStatic()}},Mario.MapState.prototype.GenerateLevel=function(){var e=0,t=0,i=0,a=new Mario.ImprovedNoise(0x8000000000000000*Math.random()|0),r=new Mario.ImprovedNoise(0x8000000000000000*Math.random()|0),o=new Mario.ImprovedNoise(0x8000000000000000*Math.random()|0);this.Level=[],this.Data=[];for(var s=512*Math.random(),h=512*Math.random(),n=512*Math.random(),M=512*Math.random(),e=0;e<21;e++)for(this.Level[e]=[],this.Data[e]=[],t=0;t<16;t++)i=2*(a.PerlinNoise(10*e+s,10*t+h)-r.PerlinNoise(10*e+n,10*t+M)),this.Level[e][t]=0<i?Mario.MapTile.Water:Mario.MapTile.Grass;for(var l=9999,p=9999,S=0,i=0,S=0;S<100&&i<12;S++)e=3*(6*Math.random()|0)+2,t=3*(5*Math.random()|0)+1,this.Level[e][t]===Mario.MapTile.Grass&&(e<l&&(l=e,p=t),this.Level[e][t]=Mario.MapTile.Level,this.Data[e][t]=-1,i++);this.Data[l][p]=-2;for(var d=!0;d;)d=this.FindConnection(21,16);if(this.FindCaps(21,16),0===this.XFarthestCap)return!1;for(this.Data[this.XFarthestCap][this.YFarthestCap]=-2,this.Data[this.XMario/16|0][this.YMario/16|0]=-11,e=0;e<21;e++)for(t=0;t<16;t++)this.Level[e][t]!==Mario.MapTile.Grass||e===this.XFarthestCap&&t===this.YFarthestCap-1||0<o.PerlinNoise(10*e+s,10*t+h)&&(this.Level[e][t]=Mario.MapTile.Decoration);return!0},Mario.MapState.prototype.FindConnection=function(e,t){for(var i=0,a=0,i=0;i<e;i++)for(a=0;a<t;a++)if(this.Level[i][a]===Mario.MapTile.Level&&-1===this.Data[i][a])return this.Connect(i,a,e,t),!0;return!1},Mario.MapState.prototype.Connect=function(e,t,i,a){for(var r,o,s,h=1e4,n=0,M=0,l=0,p=0,l=0;l<i;l++)for(p=0;p<a;p++)this.Level[l][p]===Mario.MapTile.Level&&-2===this.Data[l][p]&&(s=(r=0|Math.abs(e-l))*r+(o=0|Math.abs(t-p))*o)<h&&(n=l,M=p,h=s);this.DrawRoad(e,t,n,M),this.Level[e][t]=Mario.MapTile.Level,this.Data[e][t]=-2},Mario.MapState.prototype.DrawRoad=function(e,t,i,a){var r=!1;if(.5<Math.random()&&(r=!0),r){for(;i<e;)this.Data[e][t]=0,this.Level[e--][t]=Mario.MapTile.Road;for(;e<i;)this.Data[e][t]=0,this.Level[e++][t]=Mario.MapTile.Road}for(;a<t;)this.Data[e][t]=0,this.Level[e][t--]=Mario.MapTile.Road;for(;t<a;)this.Data[e][t]=0,this.Level[e][t++]=Mario.MapTile.Road;if(!r){for(;i<e;)this.Data[e][t]=0,this.Level[e--][t]=Mario.MapTile.Road;for(;e<i;)this.Data[e][t]=0,this.Level[e++][t]=Mario.MapTile.Road}},Mario.MapState.prototype.FindCaps=function(e,t){for(var i=0,a=0,r=-1,o=-1,s=0,h=0,n=0,i=0;i<e;i++)for(a=0;a<t;a++)if(this.Level[i][a]===Mario.MapTile.Level){for(s=0,h=i-1;h<=i+1;h++)for(n=a-1;n<=a+1;n++)this.Level[h][n]===Mario.MapTile.Road&&s++;1===s?(-1===r&&(r=i,o=a),this.Data[i][a]=0):this.Data[i][a]=1}this.XMario=16*r,this.YMario=16*o,this.Travel(r,o,-1,0)},Mario.MapState.prototype.Travel=function(e,t,i,a){if(this.Level[e][t]===Mario.MapTile.Road||this.Level[e][t]===Mario.MapTile.Level){if(this.Level[e][t]===Mario.MapTile.Road){if(1===this.Data[e][t])return;this.Data[e][t]=1}this.Level[e][t]===Mario.MapTile.Level&&(0<this.Data[e][t]?0!==this.LevelId&&0==(4*Math.random()|0)?this.Data[e][t]=-3:this.Data[e][t]=++this.LevelId:0<a&&(this.Data[e][t]=-1,a>this.Farthest&&(this.Farthest=a,this.XFarthestCap=e,this.YFarthestCap=t))),2!==i&&this.Travel(e-1,t,0,a++),3!==i&&this.Travel(e,t-1,1,a++),0!==i&&this.Travel(e+1,t,2,a++),1!==i&&this.Travel(e,t+1,3,a++)}},Mario.MapState.prototype.RenderStatic=function(){for(var e,t=0,i=0,a=0,r=0,o=0,s=Enjine.Resources.Images.worldMap,t=0;t<20;t++)for(i=0;i<15;i++)if(this.MapContext.drawImage(s,16*(this.WorldNumber/4|0),0,16,16,16*t,16*i,16,16),this.Level[t][i]===Mario.MapTile.Level)0===(e=this.Data[t][i])?this.MapContext.drawImage(s,0,112,16,16,16*t,16*i,16,16):-1===e?this.MapContext.drawImage(s,48,128,16,16,16*t,16*i,16,16):-3===e?this.MapContext.drawImage(s,0,128,16,16,16*t,16*i,16,16):-10===e?this.MapContext.drawImage(s,16,128,16,16,16*t,16*i,16,16):-11===e?this.MapContext.drawImage(s,16,112,16,16,16*t,16*i,16,16):-2===e?(this.MapContext.drawImage(s,32,112,16,16,16*t,16*(i-1),16,16),this.MapContext.drawImage(s,32,128,16,16,16*t,16*i,16,16)):this.MapContext.drawImage(s,16*(e-1),96,16,16,16*t,16*i,16,16);else if(this.Level[t][i]===Mario.MapTile.Road)a=(this.IsRoad(t-1,i)?1:0)+2*(this.IsRoad(t,i-1)?1:0)+4*(this.IsRoad(t+1,i)?1:0)+8*(this.IsRoad(t,i+1)?1:0),this.MapContext.drawImage(s,16*a,32,16,16,16*t,16*i,16,16);else if(this.Level[t][i]===Mario.MapTile.Water)for(r=0;r<2;r++)for(o=0;o<2;o++)0<=(a=(this.IsWater(2*t+(r-1),2*i+(o-1))?0:1)+2*(this.IsWater(2*t+r,2*i+(o-1))?0:1)+4*(this.IsWater(2*t+(r-1),2*i+o)?0:1)+8*(this.IsWater(2*t+r,2*i+o)?0:1)-1)&&a<=14&&this.MapContext.drawImage(s,16*a,16*(4+(r+o&1)),16,16,16*t+8*r,16*i+8*o,16,16)},Mario.MapState.prototype.IsRoad=function(e,t){return e<0&&(e=0),t<0&&(t=0),this.Level[e][t]===Mario.MapTile.Road||this.Level[e][t]===Mario.MapTile.Level},Mario.MapState.prototype.IsWater=function(e,t){var i=0,a=0;for(e<0&&(e=0),t<0&&(t=0),i=0;i<2;i++)for(a=0;a<2;a++)if(this.Level[(e+i)/2|0][(t+a)/2|0]!==Mario.MapTile.Water)return!1;return!0},Mario.MapState.prototype.Update=function(e){var t,i,a=0,r=0;8!==this.WorldNumber&&(this.XMario+=this.XMarioA,this.YMario+=this.YMarioA,t=this.XMario/16|0,i=this.YMario/16|0,this.Level[t][i]===Mario.MapTile.Road&&(this.Data[t][i]=0),0<this.MoveTime?this.MoveTime--:(this.XMarioA=0,this.YMarioA=0,this.CanEnterLevel&&Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S)&&this.Level[t][i]===Mario.MapTile.Level&&-11!==this.Data[t][i]&&this.Level[t][i]===Mario.MapTile.Level&&0!==this.Data[t][i]&&-10<this.Data[t][i]&&(a=this.WorldNumber+1,Mario.MarioCharacter.LevelString=a+"-",r=Mario.LevelType.Overground,1<this.Data[t][i]&&0==(3*Math.random()|0)&&(r=Mario.LevelType.Underground),this.Data[t][i]<0?(-2===this.Data[t][i]?(Mario.MarioCharacter.LevelString+="X",a+=2):-1===this.Data[t][i]?Mario.MarioCharacter.LevelString+="?":(Mario.MarioCharacter.LevelString+="#",a+=1),r=Mario.LevelType.Castle):Mario.MarioCharacter.LevelString+=this.Data[t][i],this.EnterLevel=!0,this.LevelDifficulty=a,this.LevelType=r),this.CanEnterLevel=!Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.S),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Left)&&this.TryWalking(-1,0),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Right)&&this.TryWalking(1,0),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Up)&&this.TryWalking(0,-1),Enjine.KeyboardInput.IsKeyDown(Enjine.Keys.Down)&&this.TryWalking(0,1)),this.WaterSprite.Update(e),this.DecoSprite.Update(e),this.HelpSprite.Update(e),Mario.MarioCharacter.Large?(this.LargeMario.X=this.XMario+this.XMarioA*e|0,this.LargeMario.Y=this.YMario+(this.YMarioA*e|0)-22,this.LargeMario.Update(e)):(this.SmallMario.X=this.XMario+this.XMarioA*e|0,this.SmallMario.Y=this.YMario+(this.YMarioA*e|0)-6,this.SmallMario.Update(e)))},Mario.MapState.prototype.TryWalking=function(e,t){var i=this.XMario/16|0,a=this.YMario/16|0,r=i+e,o=a+t;if(this.Level[r][o]===Mario.MapTile.Road||this.Level[r][o]===Mario.MapTile.Level){if(this.Level[r][o]===Mario.MapTile.Road&&0!==this.Data[r][o]&&0!==this.Data[i][a]&&-10<this.Data[i][a])return;this.XMarioA=8*e,this.YMarioA=8*t,this.MoveTime=2*this.CalcDistance(i,a,e,t)+1}},Mario.MapState.prototype.CalcDistance=function(e,t,i,a){for(var r=0;;){if(e+=i,t+=a,this.Level[e][t]!==Mario.MapTile.Road)return r;if(this.Level[e-a][t+i]===Mario.MapTile.Road)return r;if(this.Level[e+a][t-i]===Mario.MapTile.Road)return r;r++}},Mario.MapState.prototype.Draw=function(e){var t=0,i=0;if(8!==this.WorldNumber){for(e.drawImage(this.MapImage,0,0),i=0;i<=15;i++)for(t=20;0<=t;t--)this.Level[t][i]===Mario.MapTile.Water?this.IsWater(2*t-1,2*i-1)&&(this.WaterSprite.X=16*t-8,this.WaterSprite.Y=16*i-8,this.WaterSprite.Draw(e,this.camera)):this.Level[t][i]===Mario.MapTile.Decoration?(this.DecoSprite.X=16*t,this.DecoSprite.Y=16*i,this.DecoSprite.Draw(e,this.camera)):this.Level[t][i]===Mario.MapTile.Level&&-2===this.Data[t][i]&&(this.HelpSprite.X=16*t+16,this.HelpSprite.Y=16*i-16,this.HelpSprite.Draw(e,this.camera));Mario.MarioCharacter.Large?this.LargeMario.Draw(e,this.camera):this.SmallMario.Draw(e,this.camera),this.Font.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:4,Y:4},this.FontShadow.Strings[0]={String:"MARIO "+Mario.MarioCharacter.Lives,X:5,Y:5},this.Font.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:256,Y:4},this.FontShadow.Strings[1]={String:"WORLD "+(this.WorldNumber+1),X:257,Y:5},this.FontShadow.Draw(e,this.camera),this.Font.Draw(e,this.camera)}},Mario.MapState.prototype.LevelWon=function(){var e=this.XMario/16,t=this.YMario/16;-2!==this.Data[e][t]?(-3!==this.Data[e][t]?this.Data[e][t]=0:this.Data[e][t]=-10,this.RenderStatic()):this.NextWorld()},Mario.MapState.prototype.GetX=function(){return 160},Mario.MapState.prototype.GetY=function(){return 120},Mario.MapState.prototype.CheckForChange=function(e){8===this.WorldNumber&&e.ChangeState(new Mario.WinState),this.EnterLevel&&e.ChangeState(new Mario.LevelState(this.LevelDifficulty,this.LevelType))};