Mario.LevelState=function(e,t){this.LevelDifficulty=e,this.LevelType=t,this.Level=null,this.Layer=null,this.BgLayer=[],this.Paused=!1,this.Sprites=null,this.SpritesToAdd=null,this.SpritesToRemove=null,this.Camera=null,this.ShellsToCheck=null,this.FireballsToCheck=null,this.FontShadow=null,this.Font=null,this.TimeLeft=0,this.StartTime=0,this.FireballsOnScreen=0,this.Tick=0,this.Delta=0,this.GotoMapState=!1,this.GotoLoseState=!1},Mario.LevelState.prototype=new Enjine.GameState,Mario.LevelState.prototype.Enter=function(){var e,t,i,a=new Mario.LevelGenerator(320,15),r=0,s=null;for(this.Level=a.CreateLevel(this.LevelType,this.LevelDifficulty),this.LevelType===Mario.LevelType.Overground?Mario.PlayOvergroundMusic():this.LevelType===Mario.LevelType.Underground?Mario.PlayUndergroundMusic():this.LevelType===Mario.LevelType.Castle&&Mario.PlayCastleMusic(),this.Paused=!1,this.Layer=new Mario.LevelRenderer(this.Level,320,240),this.Sprites=new Enjine.DrawableManager,this.Camera=new Enjine.Camera,this.Tick=0,this.ShellsToCheck=[],this.FireballsToCheck=[],this.SpritesToAdd=[],this.SpritesToRemove=[],this.FontShadow=Mario.SpriteCuts.CreateBlackFont(),this.Font=Mario.SpriteCuts.CreateWhiteFont(),r=0;r<2;r++)e=4>>r,t=320+((16*this.Level.Width-320)/e|0),i=240+((16*this.Level.Height-240)/e|0),s=new Mario.BackgroundGenerator(t/32+1,i/32+1,0===r,this.LevelType),this.BgLayer[r]=new Mario.BackgroundRenderer(s.CreateLevel(),320,240,e);Mario.MarioCharacter.Initialize(this),this.Sprites.Add(Mario.MarioCharacter),this.StartTime=1,this.TimeLeft=200,this.GotoMapState=!1,this.GotoLoseState=!1},Mario.LevelState.prototype.Exit=function(){delete this.Level,delete this.Layer,delete this.BgLayer,delete this.Sprites,delete this.Camera,delete this.ShellsToCheck,delete this.FireballsToCheck,delete this.FontShadow,delete this.Font},Mario.LevelState.prototype.CheckShellCollide=function(e){this.ShellsToCheck.push(e)},Mario.LevelState.prototype.CheckFireballCollide=function(e){this.FireballsToCheck.push(e)},Mario.LevelState.prototype.Update=function(e){var t,i,a,r,s=0,h=0,o=!1,l=0,n=0,S=0,c=null;for(this.Delta=e,this.TimeLeft-=e,0==(0|this.TimeLeft)&&Mario.MarioCharacter.Die(),0<this.StartTime&&this.StartTime++,this.Camera.X=Mario.MarioCharacter.X-160,this.Camera.X<0&&(this.Camera.X=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),s=this.FireballsOnScreen=0;s<this.Sprites.Objects.length;s++)(a=this.Sprites.Objects[s])!==Mario.MarioCharacter&&(t=a.X-this.Camera.X,i=a.Y-this.Camera.Y,t<-64||384<t||i<-64||304<i?this.Sprites.RemoveAt(s):a instanceof Mario.Fireball&&this.FireballsOnScreen++);if(this.Paused)for(s=0;s<this.Sprites.Objects.length;s++)this.Sprites.Objects[s]===Mario.MarioCharacter?this.Sprites.Objects[s].Update(e):this.Sprites.Objects[s].UpdateNoMove(e);else{for(this.Layer.Update(e),this.Level.Update(),o=!1,this.Tick++,l=(this.Camera.X/16|0)-1;l<=1+((this.Camera.X+this.Layer.Width)/16|0);l++)for(n=(this.Camera.Y/16|0)-1;n<=1+((this.Camera.Y+this.Layer.Height)/16|0);n++)if(S=0,16*l+8>Mario.MarioCharacter.X+16&&(S=-1),16*l+8<Mario.MarioCharacter.X-16&&(S=1),null!==(c=this.Level.GetSpriteTemplate(l,n))&&(c.LastVisibleTick!==this.Tick-1&&(null!==c.Sprite&&this.Sprites.Contains(c.Sprite)||c.Spawn(this,l,n,S)),c.LastVisibleTick=this.Tick),0!==S&&(r=this.Level.GetBlock(l,n),0<(Mario.Tile.Behaviors[255&r]&Mario.Tile.Animated)&&3==(r%16/4|0)&&0==(r/16|0)&&(this.Tick-2*l)%100==0)){for(s=0;s<8;s++)this.AddSprite(new Mario.Sparkle(this,16*l+8,16*n+(16*Math.random()|0),Math.random()*S,0,0,1,5));this.AddSprite(new Mario.BulletBill(this,16*l+8+8*S,16*n+15,S)),o=!0}for(o&&Enjine.Resources.PlaySound("cannon"),s=0;s<this.Sprites.Objects.length;s++)this.Sprites.Objects[s].Update(e);for(s=0;s<this.Sprites.Objects.length;s++)this.Sprites.Objects[s].CollideCheck();for(s=0;s<this.ShellsToCheck.length;s++)for(h=0;h<this.Sprites.Objects.length;h++)this.Sprites.Objects[h]===this.ShellsToCheck[s]||this.ShellsToCheck[s].Dead||this.Sprites.Objects[h].ShellCollideCheck(this.ShellsToCheck[s])&&(Mario.MarioCharacter.Carried!==this.ShellsToCheck[s]||this.ShellsToCheck[s].Dead||(Mario.MarioCharacter.Carried=null,this.ShellsToCheck[s].Die()));for(s=this.ShellsToCheck.length=0;s<this.FireballsToCheck.length;s++)for(h=0;h<this.Sprites.Objects.length;h++)this.Sprites.Objects[h]===this.FireballsToCheck[s]||this.FireballsToCheck[s].Dead||this.Sprites.Objects[h].FireballCollideCheck(this.FireballsToCheck[s])&&this.FireballsToCheck[s].Die();this.FireballsToCheck.length=0}this.Sprites.AddRange(this.SpritesToAdd),this.Sprites.RemoveList(this.SpritesToRemove),this.SpritesToAdd.length=0,this.SpritesToRemove.length=0,this.Camera.X=Mario.MarioCharacter.XOld+(Mario.MarioCharacter.X-Mario.MarioCharacter.XOld)*e-160,this.Camera.Y=Mario.MarioCharacter.YOld+(Mario.MarioCharacter.Y-Mario.MarioCharacter.YOld)*e-120},Mario.LevelState.prototype.Draw=function(e){var t=0,i=0,a=0;for(this.Camera.X<0&&(this.Camera.X=0),this.Camera.Y<0&&(this.Camera.Y=0),this.Camera.X>16*this.Level.Width-320&&(this.Camera.X=16*this.Level.Width-320),this.Camera.Y>16*this.Level.Height-240&&(this.Camera.Y=16*this.Level.Height-240),t=0;t<2;t++)this.BgLayer[t].Draw(e,this.Camera);for(e.save(),e.translate(-this.Camera.X,-this.Camera.Y),t=0;t<this.Sprites.Objects.length;t++)0===this.Sprites.Objects[t].Layer&&this.Sprites.Objects[t].Draw(e,this.Camera);for(e.restore(),this.Layer.Draw(e,this.Camera),this.Layer.DrawExit0(e,this.Camera,0===Mario.MarioCharacter.WinTime),e.save(),e.translate(-this.Camera.X,-this.Camera.Y),t=0;t<this.Sprites.Objects.length;t++)1===this.Sprites.Objects[t].Layer&&this.Sprites.Objects[t].Draw(e,this.Camera);e.restore(),this.Layer.DrawExit1(e,this.Camera),this.DrawStringShadow(e,"MARIO "+Mario.MarioCharacter.Lives,0,0),this.DrawStringShadow(e,"00000000",0,1),this.DrawStringShadow(e,"COIN",14,0),this.DrawStringShadow(e," "+Mario.MarioCharacter.Coins,14,1),this.DrawStringShadow(e,"WORLD",24,0),this.DrawStringShadow(e," "+Mario.MarioCharacter.LevelString,24,1),this.DrawStringShadow(e,"TIME",34,0),(i=0|this.TimeLeft)<0&&(i=0),this.DrawStringShadow(e," "+i,34,1),0<this.StartTime&&(a=(a=this.StartTime+this.Delta-2)*a*.6,this.RenderBlackout(e,160,120,0|a)),0<Mario.MarioCharacter.WinTime&&(Mario.StopMusic(),900<(a=(a=Mario.MarioCharacter.WinTime+this.Delta)*a*.2)&&(Mario.GlobalMapState.LevelWon(),this.GotoMapState=!0),this.RenderBlackout(e,Mario.MarioCharacter.XDeathPos-this.Camera.X|0,Mario.MarioCharacter.YDeathPos-this.Camera.Y|0,320-a|0)),0<Mario.MarioCharacter.DeathTime&&(Mario.StopMusic(),900<(a=(a=Mario.MarioCharacter.DeathTime+this.Delta)*a*.1)&&(Mario.MarioCharacter.Lives--,this.GotoMapState=!0,Mario.MarioCharacter.Lives<=0&&(this.GotoLoseState=!0)),this.RenderBlackout(e,Mario.MarioCharacter.XDeathPos-this.Camera.X|0,Mario.MarioCharacter.YDeathPos-this.Camera.Y|0,320-a|0))},Mario.LevelState.prototype.DrawStringShadow=function(e,t,i,a){this.Font.Strings[0]={String:t,X:8*i+4,Y:8*a+4},this.FontShadow.Strings[0]={String:t,X:8*i+5,Y:8*a+5},this.FontShadow.Draw(e,this.Camera),this.Font.Draw(e,this.Camera)},Mario.LevelState.prototype.RenderBlackout=function(e,t,i,a){if(!(320<a)){for(var r=[],s=[],h=0,h=0;h<16;h++)r[h]=t+Math.cos(h*Math.PI/15)*a|0,s[h]=i+Math.sin(h*Math.PI/15)*a|0;for(r[16]=0,s[16]=i,r[17]=0,s[17]=240,r[18]=320,s[18]=240,r[19]=320,s[19]=i,e.fillStyle="#000",e.beginPath(),e.moveTo(r[19],s[19]),h=18;0<=h;h--)e.lineTo(r[h],s[h]);for(e.closePath(),e.fill(),h=0;h<16;h++)r[h]=t-Math.cos(h*Math.PI/15)*a|0,s[h]=i-Math.sin(h*Math.PI/15)*a|0;for(s[15]+=5,r[16]=320,s[16]=i,r[17]=320,s[17]=0,r[18]=0,s[18]=0,r[19]=0,s[19]=i,e.fillStyle="#000",e.beginPath(),e.moveTo(r[0],s[0]),h=0;h<=r.length-1;h++)e.lineTo(r[h],s[h]);e.closePath(),e.fill()}},Mario.LevelState.prototype.AddSprite=function(e){this.Sprites.Add(e)},Mario.LevelState.prototype.RemoveSprite=function(e){this.Sprites.Remove(e)},Mario.LevelState.prototype.Bump=function(e,t,i){var a=this.Level.GetBlock(e,t),r=0,s=0;if(0<(Mario.Tile.Behaviors[255&a]&Mario.Tile.Bumpable)&&(this.BumpInto(e,t-1),this.Level.SetBlock(e,t,4),this.Level.SetBlockData(e,t,4),0<(Mario.Tile.Behaviors[255&a]&Mario.Tile.Special)?(Enjine.Resources.PlaySound("sprout"),Mario.MarioCharacter.Large?this.AddSprite(new Mario.FireFlower(this,16*e+8,16*t+8)):this.AddSprite(new Mario.Mushroom(this,16*e+8,16*t+8))):(Mario.MarioCharacter.GetCoin(),Enjine.Resources.PlaySound("coin"),this.AddSprite(new Mario.CoinAnim(this,e,t)))),0<(Mario.Tile.Behaviors[255&a]&Mario.Tile.Breakable)&&(this.BumpInto(e,t-1),i))for(Enjine.Resources.PlaySound("breakblock"),this.Level.SetBlock(e,t,0),r=0;r<2;r++)for(s=0;s<2;s++)this.AddSprite(new Mario.Particle(this,16*e+8*r+4,16*t+8*s+4,4*(2*r-1),4*(2*s-1)-8))},Mario.LevelState.prototype.BumpInto=function(e,t){var i=this.Level.GetBlock(e,t),a=0;for(0<(Mario.Tile.Behaviors[255&i]&Mario.Tile.PickUpable)&&(Mario.MarioCharacter.GetCoin(),Enjine.Resources.PlaySound("coin"),this.Level.SetBlock(e,t,0),this.AddSprite(new Mario.CoinAnim(e,t+1))),a=0;a<this.Sprites.Objects.length;a++)this.Sprites.Objects[a].BumpCheck(e,t)},Mario.LevelState.prototype.CheckForChange=function(e){this.GotoLoseState?e.ChangeState(new Mario.LoseState):this.GotoMapState&&e.ChangeState(Mario.GlobalMapState)};